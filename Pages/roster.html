<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css?v=2">

<style>
/* ==== ROSTER PAGE STYLES ===== */

/* Shift STRIKES text left */
.roster-table th:nth-child(10),
.roster-table td:nth-child(10) {
    padding-left: 5px !important;
}

/* Shift DATE OF HIRE text left */
.roster-table th:nth-child(9),
.roster-table td:nth-child(9) {
    padding-left: 5px !important;
}

.roster-container {
    width: 95%;
    max-width: 1600px;
    margin: 150px auto 80px auto;
    font-family: "Segoe UI", Arial, sans-serif;
}

/* CATEGORY HEADERS */
.roster-category {
    font-size: 30px;
    font-weight: 800;
    margin-top: 40px;
    color: #0F2037;
    border-bottom: 3px solid #FFC300;
    padding-bottom: 8px;
}

/* TABLE */
.roster-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: #0F2037;
    color: white;
    border-radius: 8px;
    overflow: hidden;
    table-layout: fixed !important;
}

/* HEADER CELLS */
.roster-table th {
    background: #1b2f4a;
    padding: 12px;
    text-align: left;
    font-size: 16px;
    border-bottom: 2px solid #324a63;
    white-space: nowrap;
}

/* DATA CELLS */
.roster-table td {
    padding: 10px;
    font-size: 15px;
    border-bottom: 1px solid #21334d;
    white-space: nowrap;
}

/* COLUMN WIDTHS */
.roster-table th:nth-child(1),
.roster-table td:nth-child(1) { width: 7%; }

.roster-table th:nth-child(2),
.roster-table td:nth-child(2) { width: 14%; }

.roster-table th:nth-child(3),
.roster-table td:nth-child(3) { width: 7%; }

.roster-table th:nth-child(4),
.roster-table td:nth-child(4) { width: 12%; }

.roster-table th:nth-child(5),
.roster-table td:nth-child(5) { width: 12%; }

/* Hours */
.roster-table th:nth-child(6),
.roster-table td:nth-child(6) { width: 8%; }

/* Activity */
.roster-table th:nth-child(7),
.roster-table td:nth-child(7) { width: 8%; }

/* Assignments */
.roster-table th:nth-child(8),
.roster-table td:nth-child(8) { width: 18%; }

/* Date of Hire */
.roster-table th:nth-child(9),
.roster-table td:nth-child(9) { width: 8%; }

/* Strikes */
.roster-table th:nth-child(10),
.roster-table td:nth-child(10) { width: 6%; }

/* ODD ROW STRIPING */
.roster-table tr:nth-child(odd) td {
    background: #122235;
}

/* Rank Insignia */
.insignia {
    width: 36px;
    height: 36px;
    padding: 2px;
    object-fit: contain;
}

/* Mobile Hide Insignia */
@media (max-width: 800px) {
    .roster-table th:nth-child(3),
    .roster-table td:nth-child(3) { display: none; }
}

/* Activity colors */
.act-green { color: #4CFF4C !important; font-weight: 700; }
.act-yellow { color: #FFD93D !important; font-weight: 700; }
.act-red { color: #FF5252 !important; font-weight: 700; }
.act-gray { color: #9CA3AF !important; font-weight: 700; }
.act-blue { color: #4DA3FF !important; font-weight: 700; }

/* Prevent long assignment text overflow */
.roster-table td.assignments,
.roster-table th.assignments {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}
</style>
</head>

<body>

<div data-include="../Pages/components/header.html"></div>

<div class="roster-container" id="roster"></div>

<!-- FLEX WRAPPER FOR EMPLOYEES + HOURS -->
<div id="totals-wrapper" style="
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: -50px;
    margin-top: 40px;
">
    <div id="total-employees"></div>
    <div id="total-hours"></div>
</div>

<script>
const BASE = location.hostname === "fcrpfhp.github.io"
    ? "/fhp-website/"
    : "../";

/* Phone formatter */
function formatPhone(phone) {
    if (!phone) return "";
    const digits = phone.replace(/\D/g, "");
    if (digits.length !== 10) return "";
    return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
}

/* Activity color class */
function getActivityClass(activity) {
    activity = String(activity).trim().toLowerCase();
    if (activity === "active") return "act-green";
    if (activity === "partially active") return "act-yellow";
    if (activity === "inactive") return "act-red";
    if (activity === "vacant") return "act-gray";
    if (activity === "loa") return "act-blue";
    return "";
}

async function loadRoster() {
    const url =
    "https://docs.google.com/spreadsheets/d/15AgzaaRt5SLCk1gPHoB8lybfa4YW0bZD3BiKnXzNPfE/gviz/tq?gid=1051466178&tqx=out:json";

    const response = await fetch(url);
    const text = await response.text();
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
    const rows = json.table.rows;

    const COL = {
        identifier: 3,
        name: 4,
        rank: 6,
        insignia: 7,
        phone: 9,
        status: 10,
        hours1: 11,
        activity: 12,
        hours2: 13,
        doh: 14,
        assignments: 15,
        strikes: 16,
        category: 17
    };

    function categorize(id) {
        id = parseInt(id);
        if (id >= 2201 && id <= 2203) return "Troop Headquarters";
        if (id >= 2204 && id <= 2208) return "District Command Staff";
        if (id >= 2209 && id <= 2224) return "District Supervisors";
        if (id >= 2225 && id <= 2235) return "Investigators";
        if (id >= 2236 && id <= 2355) return "DAVIE & MIAMI DADE DISTRICT";
        if (id >= 2501 && id <= 2599) return "Auxiliary Patrol";
        return "Unassigned";
    }

    let data = rows.map(r => {
        const c = r.c;
        const id = c[COL.identifier]?.f ?? c[COL.identifier]?.v ?? "";

        return {
            identifier: id,
            name: c[COL.name]?.v ?? "",
            rank: c[COL.rank]?.v ?? "",
            insignia: c[COL.insignia]?.v ?? "",
            phone: c[COL.phone]?.v ?? "",
            status: c[COL.status]?.v ?? "",
            hours1: c[COL.hours1]?.f ?? c[COL.hours1]?.v ?? "",
            activity: c[COL.activity]?.v ?? "",
            hours2: c[COL.hours2]?.f ?? c[COL.hours2]?.v ?? "",
            doh: c[COL.doh]?.f ?? c[COL.doh]?.v ?? "",
            assignments: c[COL.assignments]?.v ?? "—",
            strikes: c[COL.strikes]?.v ?? "—",
            category: categorize(id)
        };
    });

    data = data.filter(r => {
        const allowEmpty =
            r.category === "Troop Headquarters" ||
            r.category === "District Command Staff" ||
            r.category === "District Supervisors";

        if (!r.name.trim()) return allowEmpty;
        return true;
    });

    data.sort((a,b) => parseInt(a.identifier) - parseInt(b.identifier));

    const RANK_MAP = {
        "Captain": "captain.png",
        "Corporal": "corporal.png",
        "Lieutenant": "luitenant.png",
        "Major": "major.png",
        "Master Corporal": "master-corporal.png",
        "Master Sergeant": "master-sergeant.png",
        "Master Trooper": "master-trooper.png",
        "Senior Corporal": "senior-corporal.png",
        "Senior Trooper": "senior-trooper.png",
        "Sergeant First Class": "sergeant-first-class.png",
        "Sergeant": "sergeant.png",
        "Staff Sergeant": "staff-sergeant.png",
        "Trooper First Class": "trooper-first-class.png",
        "Trooper": "trooper.png",
        "Trooper Specialist": "trooper-specialist.png",
        "Probationary Trooper": "trooper.png",
        "Auxiliary Sergeant": "sergeant.png",
        "Auxiliary Trooper": "trooper.png"
    };

    function resolveInsignia(rank) {
        return RANK_MAP[rank] || "default.png";
    }

    const categories = [
        "Troop Headquarters",
        "District Command Staff",
        "District Supervisors",
        "Investigators",
        "DAVIE & MIAMI DADE DISTRICT",
        "Auxiliary Patrol"
    ];

    let html = "";

    categories.forEach(cat => {
        const section = data.filter(r => r.category === cat);
        if (section.length === 0) return;

        html += `
            <div class="roster-category">${cat}</div>
            <table class="roster-table">
                <tr>
                    <th>Identifier</th>
                    <th>Name</th>
                    <th>Insignia</th>
                    <th>Rank</th>
                    <th>Phone</th>
                    <th>Hours</th>
                    <th>Activity</th>
                    <th class="assignments">Assignments</th>
                    <th>Date of Hire</th>
                    <th>Strikes</th>
                </tr>
        `;

        section.forEach(r => {
            const file = resolveInsignia(r.rank);

            let hoursDisplay = r.hours1;
            if (
                (r.category === "Troop Headquarters" || r.category === "District Command Staff") &&
                (!r.hours1 || r.hours1.trim() === "")
            ) {
                hoursDisplay = "Exempt";
            }

            const applyColor =
                ["District Supervisors", "Investigators", "DAVIE & MIAMI DADE DISTRICT", "Auxiliary Patrol"]
                .includes(r.category)
                ? getActivityClass(r.activity)
                : "";

            html += `
                <tr>
                    <td>${r.identifier}</td>
                    <td>${r.name}</td>
                    <td><img class="insignia" src="../assets/ranks/${file}" onerror="this.src='../assets/ranks/default.png'"></td>
                    <td>${r.rank}</td>
                    <td>${formatPhone(r.phone)}</td>
                    <td>${hoursDisplay}</td>
                    <td class="${applyColor}">${r.activity}</td>
                    <td class="assignments">${r.assignments}</td>
                    <td>${r.doh}</td>
                    <td>${r.strikes}</td>
                </tr>
            `;
        });

        html += `</table>`;
    });

    document.getElementById("roster").innerHTML = html;
}
</script>

<!-- EMPLOYEE TOTALS -->
<script>
async function loadEmployeeTotals() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRxO7G0XO1SVjwMnoz4UK9C3ODmUpIgGfyO_RqxDqseiBseVMePhe6DhIH7sVoaOT010jnkiDXJsez/pub?gid=1315474270&single=true&output=csv";

    const response = await fetch(url);
    const text = await response.text();

    const rows = text.trim().split("\n").map(r => r.split(","));

    let command = 0, district = 0, auxiliary = 0, fullTime = 0;

for (const r of rows) {
    const label = r[3] ? r[3].trim().toUpperCase() : "";
    const value = r[6] ? r[6].trim() : "";

    if (label === "COMMAND" && command === 0) command = value;
    if (label === "DISTRICT STAFF" && district === 0) district = value;
    if (label === "AUXILIARY" && auxiliary === 0) auxiliary = value;
    if (label === "FULL TIME" && fullTime === 0) fullTime = value;
}

    const html = `
        <div style="
            width: 450px;
            min-height: 260px;
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
        ">
            <div style="
                background: #0F2037;
                color: white;
                font-size: 24px;
                font-weight: 800;
                text-align: center;
                padding: 10px 0;
                border-radius: 4px 4px 0 0;
            ">
                TOTAL EMPLOYEES
            </div>

            <div style="
                background: #7A8697;
                padding: 20px;
                color: white;
                font-size: 18px;
                font-weight: 600;
            ">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span>COMMAND</span> <span>${command}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span>DISTRICT STAFF</span> <span>${district}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span>AUXILIARY</span> <span>${auxiliary}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>FULL TIME</span> <span>${fullTime}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById("total-employees").innerHTML = html;
}
</script>

<!-- HOURS TOTALS -->
<script>
async function loadHourTotals() {
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRxO7G0XO1SVjwMnoz4UK9C3ODmUpIgGfyO_RqxDqseiBseVMePhe6DhIH7sVoaOT010jnkiDXJsez/pub?gid=1315474270&single=true&output=csv";

    const response = await fetch(url);
    const text = await response.text();
    const rows = text.trim().split("\n").map(r => r.split(","));

    let fullTime = null, auxiliary = null, totalAgency = null;
    let inHours = false;

    for (const r of rows) {
        const label = r[3] ? r[3].trim().toUpperCase() : "";
        const value = r[6] ? r[6].trim() : "";

        if (label === "TOTAL HOURS") {
            inHours = true;
            continue;
        }

        if (!inHours) continue;

        if (label === "FULL TIME" && fullTime === null) fullTime = value;
        if (label === "AUXILIARY" && auxiliary === null) auxiliary = value;
        if (label === "TOTAL AGENCY" && totalAgency === null) totalAgency = value;
    }

    const html = `
        <div style="
            width: 450px;
            min-height: 260px;
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
        ">
            <div style="
                background: #0F2037;
                color: white;
                font-size: 24px;
                font-weight: 800;
                text-align: center;
                padding: 10px 0;
                border-radius: 4px 4px 0 0;
            ">
                TOTAL HOURS
            </div>

            <div style="
                background: #7A8697;
                padding: 20px;
                color: white;
                font-size: 18px;
                font-weight: 600;
            ">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span>FULL TIME</span> <span>${fullTime}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span>AUXILIARY</span> <span>${auxiliary}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>TOTAL AGENCY</span> <span>${totalAgency}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById("total-hours").innerHTML = html;
}
</script>

<script>
loadRoster();
loadEmployeeTotals();
loadHourTotals();
</script>

<script src="../js/include.js"></script>

<div class="footer-section"></div>

</body>
</html>